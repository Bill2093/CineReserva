@model (CineReserva.Models.Show show, List<CineReserva.Models.Seat> seats)
@{
    ViewData["Title"] = "Asientos";
    var reserved = (List<int>)ViewBag.ReservedIds;
}

<h2>@Model.show.Movie.Title — @Model.show.StartTime.ToString("g") — @Model.show.Auditorium.Name</h2>

<form id="reserveForm">
    <input type="hidden" name="ShowId" value="@Model.show.Id" />
    <div style="display:grid;grid-template-columns:repeat(@Model.show.Auditorium.SeatsPerRow,40px);gap:6px;">
        @foreach (var seat in Model.seats)
        {
            var isTaken = reserved.Contains(seat.Id);
            <label style="text-align:center;">
                <input type="checkbox" name="Seats" value="@seat.Id" @(isTaken ? "disabled" : "") />
                <div>@seat.Row-@seat.Number</div>
            </label>
        }
    </div>

    <hr />
    <input class="form-control" name="CustomerName" placeholder="Tu nombre" required />
    <input class="form-control" name="CustomerEmail" placeholder="Email" required style="margin-top:8px;" />
    <button class="btn btn-success" type="submit" style="margin-top:8px;">Reservar</button>
</form>

<div id="msg" style="margin-top:12px;"></div>

@section Scripts {
    <script>
        document.getElementById('reserveForm').addEventListener('submit', async (e) => {
          e.preventDefault();
          const fd = new FormData(e.target);
          const showId = fd.get('ShowId');
          const seats = fd.getAll('Seats').map(Number);
          const payload = {
            showId: Number(showId),
            seatIds: seats,
            customerName: fd.get('CustomerName'),
            customerEmail: fd.get('CustomerEmail')
          };

          const res = await fetch('/api/bookings', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(payload)
          });

          const msg = document.getElementById('msg');
          if (res.ok) {
            const data = await res.json();
            msg.innerText = `¡Reserva #${data.id} creada! Asientos: ${data.reservations.map(r=>r.seatId).join(', ')}`;
            setTimeout(()=> location.reload(), 800);
          } else {
            const err = await res.text();
            msg.innerText = 'Error: ' + err;
          }
        });
    </script>
}
